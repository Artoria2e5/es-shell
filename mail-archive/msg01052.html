<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: Possible fix for the signal&#45;handling problem in es&#45;0.9&#45;beta1.tar.gz -->
<!--X-From-R13: Vnenyq Vnapur&#45;Ayfra <unapurNzngu.agah.ab> -->
<!--X-Date: Fri, 15 Dec 2000 16:26:54 &#45;0500 -->
<!--X-Message-Id: 20001215113750A.hanche@math.ntnu.no -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Reference: 200012130910.eBD9ApC75012@latour.rsch.comm.mot.com -->
<!--X-Reference: 20001213200216D.hanche@math.ntnu.no -->
<!--X-Reference: 200012150404.eBF44Qf23900@latour.rsch.comm.mot.com -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: Possible fix for the signal-handling problem in es-0.9-beta1.tar.gz</title>
<link rev="made" href="mailto:hanche@math.ntnu.no">
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg01050.html">Date Prev</a>][<a href="msg01054.html">Date Next</a>][<a href="msg01048.html">Thread Prev</a>][<a href="msg01062.html">Thread Next</a>][<a href="maillist.html#01052">Date Index</a>][<a href="threads.html#01052">Thread Index</a>]
<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: Possible fix for the signal-handling problem in es-0.9-beta1.tar.gz</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: <a href="mailto:es%40hawkwind.utcs.toronto.edu">es@hawkwind.utcs.toronto.edu</a></li>
<li><em>Subject</em>: Re: Possible fix for the signal-handling problem in es-0.9-beta1.tar.gz</li>
<li><em>From</em>: Harald Hanche-Olsen &lt;<a href="mailto:hanche%40math.ntnu.no">hanche@math.ntnu.no</a>&gt;</li>
<li><em>Date</em>: Fri, 15 Dec 2000 05:37:50 -0500</li>
<li><em>In-reply-to</em>: &lt;<a href="msg01048.html">200012150404.eBF44Qf23900@latour.rsch.comm.mot.com</a>&gt;</li>
<li><em>References</em>: &lt;<a href="msg01020.html">200012130910.eBD9ApC75012@latour.rsch.comm.mot.com</a>&gt;	&lt;<a href="msg01022.html">20001213200216D.hanche@math.ntnu.no</a>&gt;	&lt;<a href="msg01048.html">200012150404.eBF44Qf23900@latour.rsch.comm.mot.com</a>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>+ Loren James Rittle &lt;rittle@latour.rsch.comm.mot.com&gt;:

| I can confirm that this tarball:
| 
| <a  rel="nofollow" href="ftp://ftp.sys.toronto.edu/pub/es/es-0.9-beta1.tar.gz">ftp://ftp.sys.toronto.edu/pub/es/es-0.9-beta1.tar.gz</a>
| 
| matches the one I have locally.

Um yes, I think that means that the diff Soren sent me in September
1997 was never made official.

I'll attach it here, for everyone to look at.  Possibly it should make
it into the official distribution?  (Or possibly not, without further
refinement - see below.)


Let me shortly reiterate its purpose:  This patch was meant to address
a problem with %readfrom and %writeto:  The two functions implementing
the &lt;{...} and &gt;{...} functionality.

The problem does not exist at all on systems which have /dev/fd/, for
there this is handled by builtins $&amp;readfrom and $&amp;writeto.  But for

But on other systems, these functions create a temporary file (or
fifo, if you preferred) /tmp/es.$var.$pid for one process to write to
and the other to read from.  Here, $var holds the number of the file
descriptor used in the parent shell.  However, since $pid is only set
when the shell starts up, and never changes when it forks, you could
get name collisions that way.

The example I quoted when first reporting this was as follows:

; for (x=1 2 3) { cat &lt;{echo $x} &amp; }
15946
15947
15948
; mknod: /tmp/es._devfd0.15685: File exists
mknod: /tmp/es._devfd0.15685: File exists
2
1
3

;

Those want more details could go back and read the thread &quot;Flaw in
%readfrom and %writeto&quot; from September 1997, if they have kept an
archive of the list.


Anyway, I have found that there is a problem with Soren's solution.
He introduced a new primitive getpid which returns the pid of the
current process, and replaces $pid in the definition of %readfrom and
%writeto by &lt;=$&amp;getpid.

So far, so good.

But he also removed the initialization of $pid from main.c and
inserted it into %batch-loop and %interactive-loop instead.  That
might not be such a clever idea, since the value of $pid can now
change in unexpected places:

; . &lt;{echo echo hi there $pid '$pid'}
hi there 93689 93689

; fork {var pid; . &lt;{echo echo hi there $pid '$pid'}; var pid}
pid = 93689
hi there 93689 49463
pid = 49463

(Ouch!)

So I suggest keeping the new primitive getpid and its usage in
%readfrom and %writeto (in initial.es), but to reject its application
in %batch-loop and %interactive-loop and to keep the initialization of
$pid in main.c the way it was.

Again, this is really only necessary on systems without /dev/fd/, and
I suppose it could be argued that the new primitive should only be
implemented on such systems.  But I think that complicates things too
much.
</pre><pre>Index: CHANGES
===================================================================
RCS file: /homes/csdayton/.CVSROOT/es/CHANGES,v
retrieving revision 1.4
diff -c -r1.4 CHANGES
*** CHANGES	1997/08/12 23:59:08	1.4
--- CHANGES	1997/09/17 05:15:24
***************
*** 1,6 ****
--- 1,15 ----
  CHANGES		-*- mode: indented-text -*- ($Revision: 1.4 $)
  =======
  
+ 0.9beta to 0.9beta1
+ -------------------
+ 
+ Created a new primitive `getpid' which runs the equivalent C function
+ and replaced the special treatment of `pid' in main.c.  This means that
+ %batch-loop and %interactive-loop now update pid.  This was done because
+ %readfrom and %writeto fail when several are used in parallel and in the
+ background on OS's that do not have /dev/fd/ file systems.
+ 
  0.9-alpha2 to 0.9beta
  ---------------------
  
Index: initial.es
===================================================================
RCS file: /homes/csdayton/.CVSROOT/es/initial.es,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -c -r1.1.1.1 -r1.2
*** initial.es	1997/04/11 20:54:33	1.1.1.1
--- initial.es	1997/09/17 05:11:38	1.2
***************
*** 1,4 ****
! # initial.es -- set up initial interpreter state ($Revision: 1.1.1.1 $)
  
  
  #
--- 1,4 ----
! # initial.es -- set up initial interpreter state ($Revision: 1.2 $)
  
  
  #
***************
*** 494,500 ****
  	fn-%readfrom = $&amp;readfrom
  } {
  	fn %readfrom var input cmd {
! 		local ($var = /tmp/es.$var.$pid) {
  			unwind-protect {
  				$input &gt; $$var
  				# text of $cmd is   command file
--- 494,500 ----
  	fn-%readfrom = $&amp;readfrom
  } {
  	fn %readfrom var input cmd {
! 		local ($var = /tmp/es.$var.&lt;=$&amp;getpid) {
  			unwind-protect {
  				$input &gt; $$var
  				# text of $cmd is   command file
***************
*** 510,516 ****
  	fn-%writeto = $&amp;writeto
  } {
  	fn %writeto var output cmd {
! 		local ($var = /tmp/es.$var.$pid) {
  			unwind-protect {
  				&gt; $$var
  				$cmd
--- 510,516 ----
  	fn-%writeto = $&amp;writeto
  } {
  	fn %writeto var output cmd {
! 		local ($var = /tmp/es.$var.$&amp;getpid) {
  			unwind-protect {
  				&gt; $$var
  				$cmd
***************
*** 625,634 ****
  #	result gets set to zero when it should not be.
  
  fn-%parse	= $&amp;parse
! fn-%batch-loop	= $&amp;batchloop
  fn-%is-interactive = $&amp;isinteractive
  
  fn %interactive-loop {
  	let (result = &lt;=true) {
  		catch @ e type msg {
  			if {~ $e eof} {
--- 625,640 ----
  #	result gets set to zero when it should not be.
  
  fn-%parse	= $&amp;parse
! 
! fn %batch-loop	{
! 	pid = &lt;=$&amp;getpid
! 	$&amp;batchloop
! }
! 
  fn-%is-interactive = $&amp;isinteractive
  
  fn %interactive-loop {
+ 	pid = &lt;=$&amp;getpid
  	let (result = &lt;=true) {
  		catch @ e type msg {
  			if {~ $e eof} {
Index: main.c
===================================================================
RCS file: /homes/csdayton/.CVSROOT/es/main.c,v
retrieving revision 1.3
retrieving revision 1.4
diff -c -r1.3 -r1.4
*** main.c	1997/08/12 23:59:28	1.3
--- main.c	1997/09/17 05:11:40	1.4
***************
*** 1,4 ****
! /* main.c -- initialization for es ($Revision: 1.3 $) */
  
  #include &quot;es.h&quot;
  
--- 1,4 ----
! /* main.c -- initialization for es ($Revision: 1.4 $) */
  
  #include &quot;es.h&quot;
  
***************
*** 44,54 ****
  	RefEnd(list);
  }
  
- /* initpid -- set $pid for this shell */
- static void initpid(void) {
- 	vardef(&quot;pid&quot;, NULL, mklist(mkstr(str(&quot;%d&quot;, getpid())), NULL));
- }
- 
  /* runesrc -- run the user's profile, if it exists */
  static void runesrc(void) {
  	char *esrc = str(&quot;%L/.esrc&quot;, varlookup(&quot;home&quot;, NULL), &quot;\001&quot;);
--- 44,49 ----
***************
*** 184,190 ****
  		runinitial();
  	
  		initpath();
- 		initpid();
  		initsignals(runflags &amp; run_interactive, allowquit);
  		hidevariables();
  		initenv(environ, protected);
--- 179,184 ----
Index: prim-sys.c
===================================================================
RCS file: /homes/csdayton/.CVSROOT/es/prim-sys.c,v
retrieving revision 1.2
retrieving revision 1.3
diff -c -r1.2 -r1.3
*** prim-sys.c	1997/08/12 23:59:33	1.2
--- prim-sys.c	1997/09/17 05:11:41	1.3
***************
*** 1,4 ****
! /* prim-sys.c -- system call primitives ($Revision: 1.2 $) */
  
  #define	REQUIRE_IOCTL	1
  
--- 1,4 ----
! /* prim-sys.c -- system call primitives ($Revision: 1.3 $) */
  
  #define	REQUIRE_IOCTL	1
  
***************
*** 64,69 ****
--- 64,73 ----
  	return mklist(mkstr(mkstatus(status)), NULL);
  }
  
+ PRIM(getpid) {
+ 	return mklist(mkstr(str(&quot;%d&quot;, getpid())), NULL);
+ }
+ 
  PRIM(run) {
  	char *file;
  	if (list == NULL)
***************
*** 444,449 ****
--- 448,454 ----
  	X(umask);
  	X(cd);
  	X(fork);
+ 	X(getpid);
  	X(run);
  	X(setsignals);
  #if BSD_LIMITS
</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="01062" href="msg01062.html">List archive [was Re: Possible fix for the signal-handling problem in es-0.9-beta1.tar.gz]</a></strong>
<ul><li><em>From:</em> Chris Siebenmann &lt;cks&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="01020" href="msg01020.html">Possible fix for the signal-handling problem in es-0.9-beta1.tar.gz</a></strong>
<ul><li><em>From:</em> Loren James Rittle &lt;rittle@latour.rsch.comm.mot.com&gt;</li></ul></li>
<li><strong><a name="01022" href="msg01022.html">Re: Possible fix for the signal-handling problem in es-0.9-beta1.tar.gz</a></strong>
<ul><li><em>From:</em> Harald Hanche-Olsen &lt;hanche@math.ntnu.no&gt;</li></ul></li>
<li><strong><a name="01048" href="msg01048.html">Re: Possible fix for the signal-handling problem in es-0.9-beta1.tar.gz</a></strong>
<ul><li><em>From:</em> Loren James Rittle &lt;rittle@latour.rsch.comm.mot.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg01050.html">Re: Problems with ~ and ~~</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg01054.html">Re: Pattern extraction and Wildcard expansion</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg01048.html">Re: Possible fix for the signal-handling problem in es-0.9-beta1.tar.gz</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01062.html">List archive [was Re: Possible fix for the signal-handling problem in es-0.9-beta1.tar.gz]</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#01052"><strong>Date</strong></a></li>
<li><a href="threads.html#01052"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>
